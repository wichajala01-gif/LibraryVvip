<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ห้องสมุดโรงเรียน — ระบบยืม-คืน & ผู้ช่วยบรรณารักษ์</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <style>
    html, body { background: #f7fafc; }
  </style>
</head>
<body class="min-h-screen">
  <header class="bg-primary-500 text-white py-6 shadow text-center">
    <h1 class="text-2xl font-bold">ระบบห้องสมุดโรงเรียน</h1>
    <p class="opacity-90">ยืม-คืน • เพิ่มหนังสือ • เข้า-ออก • ผู้ช่วยบรรณารักษ์</p>
  </header>
  <main class="max-w-5xl mx-auto p-4">
    <!-- Navigation Tabs -->
    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
      <button data-tab="borrow" class="tab-btn bg-white rounded-2xl shadow p-3 border hover:border-primary-500">ยืม–คืน</button>
      <button data-tab="addbook" class="tab-btn bg-white rounded-2xl shadow p-3 border hover:border-mint">เพิ่มหนังสือ</button>
      <button data-tab="entry" class="tab-btn bg-white rounded-2xl shadow p-3 border hover:border-grape">เข้า–ออก</button>
      <button data-tab="assistant" class="tab-btn bg-white rounded-2xl shadow p-3 border hover:border-primary-500">ผู้ช่วยบรรณารักษ์</button>
    </div>

    <!-- Borrow/Return -->
    <section id="tab-borrow" class="tab-pane mt-6 bg-white rounded-2xl shadow p-4 border">
      <h2 class="text-xl font-bold mb-2">ฟังก์ชันยืม–คืนหนังสือ</h2>
      <p class="text-sm text-gray-600 mb-4">สแกน QR Code เพื่อกรอกข้อมูลหนังสืออัตโนมัติ</p>
      <div class="mb-4">
        <div class="flex flex-wrap items-center gap-2">
          <button id="btn-start-scan" class="px-4 py-2 rounded-xl bg-primary-600 text-white">เริ่มสแกนคิวอาร์โค้ด</button>
          <button id="btn-stop-scan" class="px-4 py-2 rounded-xl bg-gray-100 border" disabled>หยุดสแกน</button>
        </div>
        <div id="qr-reader" class="mt-3 hidden rounded-xl overflow-hidden border"></div>
      </div>

      <form id="form-borrow" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="font-medium">เลขประจำตัวนักเรียน (4 หลัก)</label>
          <input id="studentId" type="text" pattern="\\d{4}" placeholder="เช่น 0123" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ชื่อนักเรียน</label>
          <input id="studentName" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ชื่อหนังสือ</label>
          <input id="bookTitle" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ผู้แต่ง</label>
          <input id="author" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">หมวดหมู่ดิวอี้</label>
          <select id="dewey" class="w-full mt-1 p-2 border rounded-xl" required></select>
        </div>
        <div>
          <label class="font-medium">สำนักพิมพ์</label>
          <input id="publisher" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ปีที่พิมพ์</label>
          <input id="year" type="text" pattern="\\d{4}" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">รหัสหนังสือ</label>
          <input id="bookCode" type="text" class="w-full mt-1 p-2 border rounded-xl" placeholder="เช่น BK-00001" required />
        </div>
        <div class="md:col-span-2">
          <label class="font-medium">ประเภทการทำรายการ</label>
          <div class="mt-1 flex items-center gap-4">
            <label class="flex items-center gap-2"><input type="radio" name="type" value="ยืม" required> ยืม</label>
            <label class="flex items-center gap-2"><input type="radio" name="type" value="คืน" required> คืน</label>
          </div>
        </div>
        <div class="md:col-span-2 flex gap-2">
          <button class="px-4 py-2 rounded-xl bg-mint text-white shadow" type="submit">บันทึกยืม–คืน</button>
          <button class="px-4 py-2 rounded-xl bg-gray-100 border" type="reset">ล้างฟอร์ม</button>
        </div>
      </form>
    </section>

    <!-- Add Book -->
    <section id="tab-addbook" class="tab-pane mt-6 bg-white rounded-2xl shadow p-4 border hidden">
      <h2 class="text-xl font-bold mb-2">เพิ่มหนังสือ</h2>
      <form id="form-addbook" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="font-medium">วันที่เพิ่ม</label>
          <input id="add-date" type="date" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ชื่อหนังสือ</label>
          <input id="add-title" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ผู้แต่ง</label>
          <input id="add-author" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">หมวดหมู่ดิวอี้</label>
          <select id="add-dewey" class="w-full mt-1 p-2 border rounded-xl" required></select>
        </div>
        <div>
          <label class="font-medium">สำนักพิมพ์</label>
          <input id="add-publisher" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ปีที่พิมพ์</label>
          <input id="add-year" type="text" pattern="\\d{4}" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div class="md:col-span-2 flex gap-2">
          <button class="px-4 py-2 rounded-xl bg-mint text-white shadow" type="submit">บันทึกหนังสือ</button>
          <button class="px-4 py-2 rounded-xl bg-gray-100 border" type="reset">ล้างฟอร์ม</button>
        </div>
      </form>
    </section>

    <!-- Entry/Exit -->
    <section id="tab-entry" class="tab-pane mt-6 bg-white rounded-2xl shadow p-4 border hidden">
      <h2 class="text-xl font-bold mb-2">บันทึกเข้า–ออกห้องสมุด</h2>
      <form id="form-entry" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="font-medium">เลขประจำตัวนักเรียน (4 หลัก)</label>
          <input id="entry-studentId" type="text" pattern="\\d{4}" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ชื่อนักเรียน</label>
          <input id="entry-studentName" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div class="md:col-span-2">
          <label class="font-medium">ประเภท</label>
          <div class="mt-1 flex items-center gap-4">
            <label class="flex items-center gap-2"><input type="radio" name="entryType" value="เข้า" required> เข้า</label>
            <label class="flex items-center gap-2"><input type="radio" name="entryType" value="ออก" required> ออก</label>
          </div>
        </div>
        <div class="md:col-span-2 flex gap-2">
          <button class="px-4 py-2 rounded-xl bg-mint text-white shadow" type="submit">บันทึก</button>
          <button class="px-4 py-2 rounded-xl bg-gray-100 border" type="reset">ล้างฟอร์ม</button>
        </div>
      </form>
    </section>

    <!-- Assistant -->
    <section id="tab-assistant" class="tab-pane mt-6 bg-white rounded-2xl shadow p-4 border hidden">
      <h2 class="text-xl font-bold mb-2">ผู้ช่วยบรรณารักษ์</h2>
      <form id="form-assistant" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="font-medium">เลขประจำตัวนักเรียน (4 หลัก)</label>
          <input id="as-studentId" type="text" pattern="\\d{4}" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div>
          <label class="font-medium">ชื่อนักเรียน</label>
          <input id="as-studentName" type="text" class="w-full mt-1 p-2 border rounded-xl" required />
        </div>
        <div class="md:col-span-2">
          <label class="font-medium">งานที่ทำวันนี้</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
            <label><input type="checkbox" name="tasks" value="กวาดพื้น"> กวาดพื้น</label>
            <label><input type="checkbox" name="tasks" value="ถูพื้น"> ถูพื้น</label>
            <label><input type="checkbox" name="tasks" value="จัดเก็บหนังสือ"> จัดเก็บหนังสือ</label>
            <label><input type="checkbox" name="tasks" value="เช็ดโต๊ะ"> เช็ดโต๊ะ</label>
            <label><input type="checkbox" name="tasks" value="บริการยืม–คืน"> บริการยืม–คืน</label>
            <label><input type="checkbox" name="tasks" value="เช็ดชั้นหนังสือ"> เช็ดชั้นหนังสือ</label>
          </div>
        </div>
        <div class="md:col-span-2 flex gap-2">
          <button class="px-4 py-2 rounded-xl bg-mint text-white shadow" type="submit">บันทึกผู้ช่วย</button>
          <button class="px-4 py-2 rounded-xl bg-gray-100 border" type="reset">ล้างฟอร์ม</button>
        </div>
      </form>
    </section>

  </main>

  <script>
    const APP_URL = 'https://script.google.com/macros/s/AKfycbwZzODVABJ4H5e6IcMkljn_djImg3hP6gVF9fNBknM2pFdX9a9w3ZsXezaFp6pFJvr3HA/exec';
    const DEWEY_OPTIONS = [
      '000 สารานุกรม/คอมพิวเตอร์', '100 ปรัชญา', '200 ศาสนา', '300 สังคมศาสตร์',
      '400 ภาษา', '500 วิทยาศาสตร์', '600 วิทยาศาสตร์ประยุกต์', '700 ศิลปะ',
      '800 วรรณคดี', '900 ประวัติศาสตร์/ภูมิศาสตร์'
    ];

    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    // Fill Dewey dropdowns
    ['#dewey','#add-dewey'].forEach(id=>{
      const el=$(id);
      el.innerHTML='<option value="">-- เลือกหมวดหมู่ --</option>'+
        DEWEY_OPTIONS.map(v=>`<option value="${v}">${v}</option>`).join('');
    });

    // Tabs
    $$('.tab-btn').forEach(btn=>btn.addEventListener('click',()=>{
      const tab=btn.dataset.tab;
      $$('.tab-pane').forEach(p=>p.classList.add('hidden'));
      $('#tab-'+tab).classList.remove('hidden');
    }));

    // JSONP helper
    function serialize(obj){ return Object.keys(obj).map(k=>`${encodeURIComponent(k)}=${encodeURIComponent(obj[k])}`).join('&'); }
    function jsonp(params){
      return new Promise((resolve,reject)=>{
        const cb='cb_'+Math.random().toString(36).slice(2);
        window[cb]=data=>{ resolve(data); cleanup(); };
        const s=document.createElement('script');
        s.src=APP_URL+'?'+serialize({...params, callback:cb});
        s.onerror=()=>{ reject(new Error('JSONP error')); cleanup(); };
        document.body.appendChild(s);
        function cleanup(){ delete window[cb]; s.remove(); }
        setTimeout(()=>{ reject(new Error('timeout')); cleanup(); },15000);
      });
    }

    // -------------------- Submit forms --------------------
    function submitForm(formId, payload){
      Swal.fire({title:'กำลังบันทึก...', didOpen:()=>Swal.showLoading(), allowOutsideClick:false});
      jsonp(payload).then(res=>{
        if(res && res.ok){ Swal.fire({icon:'success',title:'บันทึกสำเร็จ'}); $(form
